import{_ as i,o as e,c as a,ah as t}from"./chunks/framework.PKn7PQPU.js";const c=JSON.parse('{"title":"Dynamic Router","description":"","frontmatter":{},"headers":[],"relativePath":"en/_common/admin/dynamicRouter.md","filePath":"en/_common/admin/dynamicRouter.md"}'),n={name:"en/_common/admin/dynamicRouter.md"};function o(l,s,h,r,p,d){return e(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="dynamic-router" tabindex="-1">Dynamic Router <a class="header-anchor" href="#dynamic-router" aria-label="Permalink to &quot;Dynamic Router&quot;">​</a></h1><p>The dynamic routing mechanism of TechUI is the core of the backend management system. It adopts a <strong>Backend Control Strategy</strong>, meaning the routing table is not hardcoded on the frontend. Instead, based on the current logged-in user&#39;s permissions, the backend returns menu data, and the frontend dynamically generates Vue Router configurations by combining this data with the local component registry.</p><h2 id="working-principle" tabindex="-1">Working Principle <a class="header-anchor" href="#working-principle" aria-label="Permalink to &quot;Working Principle&quot;">​</a></h2><ol><li><strong>Component Registration:</strong> The frontend maintains a <code>register.js</code> file to map route identifiers (strings) to actual Vue component files.</li><li><strong>Fetch Menus:</strong> After the user logs in, the menu tree data is retrieved from the backend or a local database.</li><li><strong>Route Matching:</strong> The <code>routerPackag</code> function matches the <code>label</code> in the menu data with the component registry.</li><li><strong>Dynamic Mounting:</strong> Matches components are mounted under the parent route named <code>layout</code> using <code>router.addRoute</code>.</li><li><strong>Global Interception:</strong> Logic for page refreshes, authentication, and adding Tabs is handled in <code>router.beforeEach</code>.</li></ol><h2 id="core-process-analysis" tabindex="-1">Core Process Analysis <a class="header-anchor" href="#core-process-analysis" aria-label="Permalink to &quot;Core Process Analysis&quot;">​</a></h2><p>The logic for dynamic routing is mainly concentrated in the global Provider component and is only activated when <code>isActAdminFeatures</code> is true.</p><h3 id="data-persistence-and-synchronization" tabindex="-1">Data Persistence and Synchronization <a class="header-anchor" href="#data-persistence-and-synchronization" aria-label="Permalink to &quot;Data Persistence and Synchronization&quot;">​</a></h3><p>To prevent the loss of Vuex/Pinia state when the page refreshes, TechUI implements a dual persistence mechanism:</p><ul><li><strong>User Info (UserInfo):</strong> Watches <code>$tState.ADMIN.userInfo</code>. Once it changes, it uses <code>tStoreCrypto</code> (encrypted storage) to sync to Session/Local Storage. Simultaneously, if the Token or ID is found missing, it automatically triggers a logout.</li><li><strong>Menu Data (Menu):</strong> Watches <code>$tState.ADMIN.menu</code>. Once menu data is obtained, it is written to <strong>IndexedDB</strong> (<code>TuiDB</code>). This ensures that even if the user refreshes the page, the massive menu structure can be quickly restored from the local database without requesting the backend again.</li></ul><h3 id="route-assembly-routerpackag" tabindex="-1">Route Assembly (routerPackag) <a class="header-anchor" href="#route-assembly-routerpackag" aria-label="Permalink to &quot;Route Assembly (routerPackag)&quot;">​</a></h3><p><code>routerPackag</code> is the core function that converts business data into route configurations.</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Pseudo-code logic demonstration</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> routerPackag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">routerData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">routerData.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. Destructure backend data</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { label, icon, title, keepAlive, ... } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> routerData[i];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. Look up component in the registry</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> comp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $tState.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ADMIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.componentRegister[label];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. If it is not a parent node and the component exists</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">isParent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> comp){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 4. Dynamically add route to the &#39;layout&#39; parent node</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addRoute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;layout&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        path: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> label, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Default path is /label</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        name: label,       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Route name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        component: comp,   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Corresponding Vue component</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        meta: { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Inject meta info</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Key Points:</strong></p><ul><li>All dynamic routes are child routes of the <code>layout</code> route. This means they will all be rendered in the <code>&lt;router-view&gt;</code> of <code>TuiAdminLayout</code>.</li><li>The <code>name</code> and <code>path</code> of the route are generated based on the <code>label</code> to ensure uniqueness.</li></ul><h3 id="global-route-interception-guard" tabindex="-1">Global Route Interception (Guard) <a class="header-anchor" href="#global-route-interception-guard" aria-label="Permalink to &quot;Global Route Interception (Guard)&quot;">​</a></h3><p><code>router.beforeEach</code> assumes the role of a &quot;Gatekeeper&quot;, handling complex initialization logic:</p><p><strong>Phase 1: State Restoration</strong></p><ul><li><strong>User Restoration:</strong> If there is no UserID in the state tree, it attempts to read the Token from local storage to restore the login state.</li><li><strong>Menu Restoration:</strong> If there is no menu data in the state tree, it attempts to read cached menus from IndexedDB (<code>TuiDB</code>).</li></ul><p><strong>Phase 2: Dynamic Loading</strong></p><ul><li><strong>Initialization Check:</strong> Checks the <code>$ARouterInited</code> flag.</li><li><strong>Execute Loading:</strong> If not initialized, calls <code>routerPackag($AMenu.value)</code> to execute route mounting.</li><li><strong>State Flip:</strong> After mounting is complete, sets <code>$ADMIN.value.routerInited</code> to <code>true</code> and re-triggers the route navigation (<code>next({ ...to })</code>) to ensure the new routes take effect.</li></ul><p><strong>Phase 3: Business Processing</strong></p><ul><li><strong>Tab Management:</strong> If the target route is valid and has a <code>label</code> set, <code>tabAdd(to)</code> is automatically called to add it to the top tab bar.</li><li><strong>Cache Management:</strong> If <code>meta.keepAlive</code> is true, its <code>name</code> is automatically added to the <code>$AKeepAlive</code> list.</li><li><strong>Authentication Failure:</strong> If none of the above checks pass (no Token, no ID), it forces a redirect to <code>/login</code>.</li></ul><h2 id="structure-specification" tabindex="-1">Structure Specification <a class="header-anchor" href="#structure-specification" aria-label="Permalink to &quot;Structure Specification&quot;">​</a></h2><p>To work with dynamic routing, the menu data returned by the backend (or local Mock data) should conform to the following JSON structure:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;label&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dashboard&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Core field: corresponds to the key name in register.js</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;title&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Dashboard&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Page title</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;icon&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ti-dashboard&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Menu icon</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;isParent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Whether it is a parent menu directory</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;keepAlive&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Whether to enable page caching</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;hideInMenu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Whether to hide in the sidebar</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;hideInTab&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Whether to hide in the Tab bar</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;parentId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;root&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // Parent node ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><h2 id="faq" tabindex="-1">FAQ <a class="header-anchor" href="#faq" aria-label="Permalink to &quot;FAQ&quot;">​</a></h2><p><strong>Q: Why do I get a 404 after refreshing the page?</strong><strong>A:</strong> This is usually because the dynamic routes have not finished loading yet. TechUI&#39;s <code>beforeEach</code> logic handles this situation: upon refresh, it first restores the menu from IndexedDB and re-registers the routes before executing the jump. If a 404 occurs, please check if IndexedDB has successfully written the <code>menus</code> data.</p><p><strong>Q: How do I configure a new page?</strong><strong>A:</strong> Two steps are required:</p><ol><li>Import the <code>.vue</code> file in the frontend <code>register.js</code> and export it.</li><li>Add the corresponding menu item in the backend (or Mock data), ensuring the <code>label</code> matches the key name in <code>register.js</code>.</li></ol>`,29)])])}const g=i(n,[["render",o]]);export{c as __pageData,g as default};
